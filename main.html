<!DOCTYPE html>
<html lang="en">

<input type="file" id="foo" name="file1" multiple="multiple" />
<input name="file" type="text" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">
  function standardizePcarsDate(data) {
    // Parses the PCAR date line, returns object indicating what to document
    let active_services = [1, 2, 3, 4, 5]
    let service_type = 1
    let date = "18 Oct 29"
    return {
      date: "18 Oct 29",
      service_type: 2,
      active_service: service_type in active_services
    }
  }

  function standardizeMpcarsDate(data) {
    // Parses the MPCAR date line, returns object indicating what to document
    let active_services = [1, 2, 3, 4, 5]
    let service_type = 1
    let date = "18-Oct-29"
    return {
      date: "18-Oct-29",
      service_type: 2,
      active_service: service_type in active_services
    }
  }

  function determineADTime(data) {
    // PTS ACRD TO DD MMM YYYY XXXX ---- ---- ---- --- -----   ZZZZZ
    // EX:
    // ' PTS ACRD TO 23 OCT 2018 5571 0081 0000 0051 241 05944   05717
    // Finds the XXXX value which is Prior Active time
    // Finds the YYYY value whish is total satsvc
  }

  function data_to_index_map(data) {
    // example of "data"
    // 'will,montgomery,2018,apr,18,2018,aug,20,00,11,31,02,10,17,03,06,04,2019,apr,18,2018,aug,20'
    let split_members = data.split(',');
    let index_map = {
      first_name: 0,
      last_name: 1,
      period_start_year: 2,
      period_start_month: 3,
      period_start_day: 4,
      period_stop_year: 5,
      period_stop_month: 6,
      period_stop_day: 7,
      net_active_year: 8,
      net_active_month: 9,
      net_active_day: 10,
      prior_active_year: 11,
      prior_active_month: 12,
      prior_active_day: 13,
      prior_inactive_active_year: 14,
      prior_inactive_month: 15,
      prior_inactive_day: 16,
    };
    var mapped_data = Object.keys(index_map).reduce(function(obj, key) {
      obj[key] = split_members[index_map[key]];
      return obj;
    }, {});
    return mapped_data;
  }

  function log_console(log_input) {
    // not really the best thing here, but provides a bit more clarity for environments 
    // dev console is disabled
    if (log_input == "") {
      log_input = " ";
    }
    $("#log_content").append('<div> > ' + log_input + '</div>');
  }
  async function readFileAsText(file) {
    let reader = new FileReader();
    reader.readAsText(file);
    let result_base64 = new Promise((resolve) => {
      let fileReader = new FileReader();
      fileReader.onload = (e) => resolve(fileReader.result);
      fileReader.readAsText(file);
    });
    return await result_base64;
  }

  function findByMatchingProperties(set, properties) {
    return set.filter(function(entry) {
      return Object.keys(properties).every(function(key) {
        return entry[key] === properties[key];
      });
    });
  }

  function setupWorkArea(runFileData, inputFiles) {
    let workarea = {};
    log_console(inputFiles)
    // "will,montgomery,apr,18,2018,aug,20,00,11,31,02,10,17,03,06,04,2019,apr,18,2018,aug,20"
    $.each(runFileData.split('\n'), function(index, memberList) {
      //log_console(memberList);      
      let dataMap = data_to_index_map(memberList);
      let nameBase = `${dataMap['first_name']}_${dataMap['last_name']}`
      console.log(nameBase);
      console.log(inputFiles);
      var pcarsResult = findByMatchingProperties([...inputFiles], {
        name: nameBase + ".pcars"
      });
      var mpcarsResult = findByMatchingProperties([...inputFiles], {
        name: nameBase + ".mpcars"
      });
      if (!Array.isArray(pcarsResult) || pcarsResult.length != 1 ||
        !Array.isArray(mpcarsResult) || mpcarsResult.length != 1) {
        log_console(
          `Missing files for member: ${nameBase} expected files: "${nameBase + ".pcars"}", "${nameBase + ".mpcars"}"`
        )
        log_console(
          "Please correct and resubmit, optionally remove from the run.all file until that member is corrected")
        // We are done until this is corrected.
        throw new Error();
      } else {
        log_console(`All files found for member: ${nameBase}`)
      }
    })
  }
  $(document).ready(function() {
    $("input[name=file1]").change(function() {
      let main_file = 'run.all';
      let all_files = $(this).get(0).files;
      $.each($(this).get(0).files, function(index, item) {
        log_console(item.name);
      });
      $.each($(this).get(0).files, function(index, file) {
        if (file.name == main_file) {
          log_console('FOUND IT')
          let data = readFileAsText(file)
          data.then((value) => setupWorkArea(value, all_files));
          return;
        }
      })
    });
  });
</script>

<div id="log_container" style="background-color: #000000;
  width: 100%;
  height: 100%;
  max-width: 400px
  max-height: 400px">
  <div id="log_content" style="color: #ffffffff; font-size: 12px; font-family: monospace;">
    <p>************</p>
  </div>
</div>

</html>